<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ä½œæ™‚é–“è¦åŠƒèˆ‡è¿½è¹¤ç³»çµ± v3.5 (24Håˆ¶ä¿®å¾©ç‰ˆ)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/zh-tw.min.js"></script>
    
    <script type="text/javascript" src="https://unpkg.com/vis-timeline/standalone/umd/vis-timeline-graph2d.min.js"></script>
    <link href="https://unpkg.com/vis-timeline/styles/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/zh-tw.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #f3f4f6; }
        #visualization { margin-top: 20px; border: 1px solid #e5e7eb; background: white; border-radius: 8px; }
        .vis-item.expected { background-color: #e0f2fe; border-color: #38bdf8; color: #0c4a6e; } 
        .vis-item.actual { background-color: #dcfce7; border-color: #4ade80; color: #14532d; }
        .vis-item { border-radius: 4px; font-size: 14px; }
        .editing-mode { border: 2px solid #f59e0b; background-color: #fffbeb; }
        
        /* é®ç½©æ¨£å¼ */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column;
            color: #333;
        }
        /* ä¿®æ­£ Flatpickr è¼¸å…¥æ¡†æ¨£å¼ */
        input.flatpickr-input { background-color: white; }
    </style>
</head>
<body class="p-6">

    <div id="loadingOverlay">
        <div class="text-2xl font-bold mb-4">â˜ï¸ é›²ç«¯è³‡æ–™é€£ç·šä¸­...</div>
        <div id="loadingMsg" class="text-sm text-gray-500">æ­£åœ¨åŒæ­¥è³‡æ–™ï¼Œè«‹ç¨å€™...</div>
        <div id="errorActions" class="mt-6 hidden text-center">
            <p class="text-red-500 font-bold mb-2">ç™¼ç”ŸéŒ¯èª¤</p>
            <p id="errorDetail" class="text-xs text-gray-600 mb-4 max-w-md break-all px-4"></p>
            <button onclick="location.reload()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 shadow">é‡æ–°æ•´ç†</button>
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <header class="mb-6 flex justify-between items-end">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">â˜ï¸ é›²ç«¯å·¥ä½œè¿½è¹¤ç³»çµ±</h1>
                <p class="text-gray-600">v3.5 æ­£å¼ç‰ˆ (24å°æ™‚åˆ¶)</p>
            </div>
            <div id="connectionStatus" class="text-sm font-bold text-gray-400">åˆå§‹åŒ–ä¸­...</div>
        </header>

        <div id="inputFormCard" class="bg-white p-6 rounded-lg shadow mb-6 transition-colors duration-300">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 id="formTitle" class="text-xl font-semibold">æ–°å¢å·¥ä½œé …ç›®</h2>
                <span id="editStatus" class="hidden text-sm font-bold text-amber-600 bg-amber-100 px-2 py-1 rounded">âœï¸ æ­£åœ¨ç·¨è¼¯æ¨¡å¼</span>
            </div>
            
            <input type="hidden" id="editJobId">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">å·¥ä½œä¸»æ—¨ <span class="text-red-500">*</span></label>
                        <input type="text" id="jobTitle" class="mt-1 block w-full rounded-md border border-gray-300 p-2 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="ä¾‹å¦‚ï¼šç¶²ç«™å‰ç«¯é–‹ç™¼">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">å·¥ä½œå…§å®¹</label>
                        <textarea id="jobContent" class="mt-1 block w-full rounded-md border border-gray-300 p-2 shadow-sm" rows="3" placeholder="è©³ç´°å…§å®¹æè¿°..."></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">å‚™è¨»</label>
                        <input type="text" id="remarks" class="mt-1 block w-full rounded-md border border-gray-300 p-2 shadow-sm" placeholder="ä¾‹å¦‚ï¼šéœ€ç­‰å¾…è¨­è¨ˆåœ–ç¢ºèª">
                    </div>
                </div>

                <div class="space-y-3 bg-gray-50 p-4 rounded border border-gray-200">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-bold text-blue-700">ğŸ”µ é è¨ˆé–‹å§‹ <span class="text-red-500">*</span></label>
                            <input type="text" id="estStart" class="mt-1 block w-full rounded border border-gray-300 p-2 bg-white" placeholder="é»æ“Šé¸æ“‡æ™‚é–“">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-blue-700">é è¨ˆçµæŸ <span class="text-red-500">*</span></label>
                            <input type="text" id="estEnd" class="mt-1 block w-full rounded border border-gray-300 p-2 bg-white" placeholder="é»æ“Šé¸æ“‡æ™‚é–“">
                        </div>
                    </div>
                    <hr class="border-gray-300">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-bold text-green-700">ğŸŸ¢ å¯¦éš›é–‹å§‹ (é¸å¡«)</label>
                            <input type="text" id="actStart" class="mt-1 block w-full rounded border border-gray-300 p-2 bg-white" placeholder="é»æ“Šé¸æ“‡æ™‚é–“">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-green-700">å¯¦éš›çµæŸ (é¸å¡«)</label>
                            <input type="text" id="actEnd" class="mt-1 block w-full rounded border border-gray-300 p-2 bg-white" placeholder="é»æ“Šé¸æ“‡æ™‚é–“">
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="cancelEditBtn" onclick="resetForm()" class="hidden px-4 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50">å–æ¶ˆç·¨è¼¯</button>
                <button onclick="clearAllData()" class="text-sm text-red-400 hover:text-red-600 underline mr-auto">æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
                <button id="submitBtn" onclick="handleFormSubmit()" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 shadow font-bold transition-colors">æ–°å¢å·¥ä½œ</button>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-2">ğŸ“Š æ™‚é–“è»¸è¦–åœ–</h2>
            <div id="visualization"></div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow overflow-x-auto">
            <h2 class="text-xl font-semibold mb-4">ğŸ“‹ è©³ç´°æ¸…å–®</h2>
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ“ä½œ</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">ä¸»æ—¨</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">å…§å®¹</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-blue-600 uppercase">é è¨ˆæ™‚é–“</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-green-600 uppercase">å¯¦éš›æ™‚é–“</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">å‚™è¨»</th>
                    </tr>
                </thead>
                <tbody id="jobTableBody" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
            </table>
        </div>
    </div>

    <script>
        // ==========================================
        //  1. è®Šæ•¸èˆ‡è¨­å®š
        // ==========================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyB7coN0YZ5XFvSG4vrD4rvLRGSVH_kmCxY",
            authDomain: "worktracker-41d89.firebaseapp.com",
            databaseURL: "https://worktracker-41d89-default-rtdb.firebaseio.com",
            projectId: "worktracker-41d89",
            storageBucket: "worktracker-41d89.firebasestorage.app",
            messagingSenderId: "182899210000",
            appId: "1:182899210000:web:d86f11e118e6fb68e75795"
        };

        let db = null;
        let jobs = [];
        let timeline, items, groups;
        let loadingTimeout;
        
        // å­˜æ”¾ Flatpickr å¯¦ä¾‹
        let fpEstStart, fpEstEnd, fpActStart, fpActEnd;

        // ==========================================
        //  2. æ ¸å¿ƒåŠŸèƒ½ (å…ˆå®šç¾©ï¼Œè§£æ±º ReferenceError)
        // ==========================================

        function showError(msg) {
            document.getElementById('loadingMsg').innerText = "ç™¼ç”ŸéŒ¯èª¤";
            document.getElementById('errorDetail').innerText = msg;
            document.getElementById('errorActions').classList.remove('hidden');
        }

        // --- åˆ·æ–°æ™‚é–“è»¸ ---
        function refreshTimelineData() {
            if(!groups || !items) return;
            groups.clear();
            items.clear();
            
            jobs.forEach(job => {
                groups.add({ id: job.id, content: `<span style="font-weight:bold">${job.title}</span>` });

                items.add({
                    id: job.id + '_est',
                    group: job.id,
                    content: 'é è¨ˆ',
                    start: job.estStart,
                    end: job.estEnd,
                    className: 'expected',
                    title: `é è¨ˆ: ${job.estStart} ~ ${job.estEnd}`
                });

                if (job.actStart && job.actEnd) {
                    items.add({
                        id: job.id + '_act',
                        group: job.id,
                        content: 'å¯¦éš›',
                        start: job.actStart,
                        end: job.actEnd,
                        className: 'actual',
                        title: `å¯¦éš›: ${job.actStart} ~ ${job.actEnd}`
                    });
                }
            });
            
            if(jobs.length > 0) {
                timeline.fit(); 
            }
        }

        // --- åˆ·æ–°è¡¨æ ¼ ---
        function renderTable() {
            const tbody = document.getElementById('jobTableBody');
            tbody.innerHTML = '';
            const sortedJobs = [...jobs].sort((a, b) => new Date(b.estStart) - new Date(a.estStart));

            sortedJobs.forEach(job => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-3 py-4 whitespace-nowrap text-sm font-medium">
                        <button onclick="loadJobToEdit(${job.id})" class="text-indigo-600 hover:text-indigo-900 mr-3 bg-indigo-50 px-2 py-1 rounded">ç·¨è¼¯</button>
                        <button onclick="deleteJob(${job.id})" class="text-red-600 hover:text-red-900 bg-red-50 px-2 py-1 rounded">åˆªé™¤</button>
                    </td>
                    <td class="px-3 py-4 font-medium text-gray-900">${job.title}</td>
                    <td class="px-3 py-4 text-gray-500 max-w-xs truncate" title="${job.content}">${job.content}</td>
                    <td class="px-3 py-4 text-gray-500 text-xs">
                        ${formatDate(job.estStart)}<br>â†“<br>${formatDate(job.estEnd)}
                    </td>
                    <td class="px-3 py-4 text-gray-500 text-xs">
                        ${(job.actStart && job.actEnd) ? 
                          formatDate(job.actStart) + '<br>â†“<br>' + formatDate(job.actEnd) : 
                          '<span class="text-gray-300">å¾…å¡«å¯«</span>'}
                    </td>
                    <td class="px-3 py-4 text-gray-500 text-xs">${job.remarks}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- å„²å­˜è³‡æ–™ ---
        function saveDataToCloud(newJobsData) {
            if(!db) return;
            db.ref('workJobs').set(newJobsData)
                .then(() => console.log("åŒæ­¥æˆåŠŸ"))
                .catch((err) => {
                    console.error(err);
                    alert("å„²å­˜å¤±æ•—ï¼\néŒ¯èª¤: " + err.message);
                });
        }

        // --- åˆå§‹åŒ–æ™‚é–“è»¸ ---
        function initTimeline() {
            const container = document.getElementById('visualization');
            groups = new vis.DataSet();
            items = new vis.DataSet();

            const options = {
                groupOrder: 'content',
                editable: { add: false, updateTime: true, updateGroup: false, remove: true },
                margin: { item: 10 },
                orientation: 'top',
                stack: false,
                zoomKey: 'ctrlKey',
                maxHeight: '500px',
                verticalScroll: true,
                format: {
                    minorLabels: { minute: 'HH:mm', hour: 'HH:mm', weekday: 'M/D (ddd)', day: 'M/D (ddd)', month: 'YYYYå¹´ Mæœˆ' },
                    majorLabels: { minute: 'ddd D HH:mm', hour: 'ddd D HH:mm', weekday: 'YYYYå¹´ Mæœˆ', day: 'YYYYå¹´ Mæœˆ', month: 'YYYYå¹´' }
                },
                zoomMin: 1000 * 60 * 60, 
            };

            timeline = new vis.Timeline(container, items, groups, options);
            
            items.on('update', function (event, properties) {
                if (properties.data && properties.data.length > 0) {
                    updateJobFromTimeline(properties.data[0]);
                }
            });
        }

        // --- åˆå§‹åŒ– Flatpickr (å¼·åˆ¶24å°æ™‚åˆ¶) ---
        function initPickers() {
            const commonConfig = {
                enableTime: true,
                dateFormat: "Y-m-d H:i", // æ¨™æº– ISO æ ¼å¼ (YYYY-MM-DD HH:mm)
                time_24hr: true,         // âœ… é—œéµï¼šå¼·åˆ¶ 24 å°æ™‚åˆ¶
                locale: "zh_tw",         // ä¸­æ–‡ä»‹é¢
                minuteIncrement: 30      // åˆ†é˜è·³è½‰å–®ä½ (å¯æ”¹ 1, 5, 15)
            };

            fpEstStart = flatpickr("#estStart", commonConfig);
            fpEstEnd   = flatpickr("#estEnd",   commonConfig);
            fpActStart = flatpickr("#actStart", commonConfig);
            fpActEnd   = flatpickr("#actEnd",   commonConfig);
        }

        // --- æ›´æ–°è³‡æ–™ ---
        function updateJobFromTimeline(item) {
            const jobId = parseInt(item.group);
            const type = item.id.split('_')[1];
            const jobIndex = jobs.findIndex(j => j.id === jobId);
            
            if (jobIndex > -1) {
                const toLocalISO = (date) => {
                    // è½‰ç‚º "YYYY-MM-DD HH:mm" å­—ä¸²
                    return moment(date).format("YYYY-MM-DD HH:mm");
                };

                let updatedJobs = [...jobs];
                let job = {...updatedJobs[jobIndex]};
                
                if (type === 'est') {
                    job.estStart = toLocalISO(item.start);
                    job.estEnd = toLocalISO(item.end);
                } else if (type === 'act') {
                    job.actStart = toLocalISO(item.start);
                    job.actEnd = toLocalISO(item.end);
                }
                
                updatedJobs[jobIndex] = job;
                saveDataToCloud(updatedJobs);
                
                if(document.getElementById('editJobId').value == jobId) {
                    loadJobToEdit(jobId);
                }
            }
        }

        // --- æäº¤ ---
        function handleFormSubmit() {
            if(!db) { alert("å°šæœªé€£ç·šåˆ°è³‡æ–™åº«"); return; }
            
            const idInput = document.getElementById('editJobId').value;
            const title = document.getElementById('jobTitle').value;
            const content = document.getElementById('jobContent').value;
            const estStart = document.getElementById('estStart').value; // é€™è£¡æŠ“åˆ°çš„å€¼å°±æ˜¯ "YYYY-MM-DD HH:mm"
            const estEnd = document.getElementById('estEnd').value;
            const actStart = document.getElementById('actStart').value;
            const actEnd = document.getElementById('actEnd').value;
            const remarks = document.getElementById('remarks').value;

            if (!title || !estStart || !estEnd) {
                alert("è«‹å‹™å¿…å¡«å¯«ï¼šå·¥ä½œä¸»æ—¨ã€é è¨ˆé–‹å§‹æ™‚é–“ã€é è¨ˆçµæŸæ™‚é–“");
                return;
            }
            if (new Date(estStart) > new Date(estEnd)) {
                alert("é è¨ˆé–‹å§‹æ™‚é–“ä¸èƒ½æ™šæ–¼çµæŸæ™‚é–“");
                return;
            }

            const jobData = {
                id: idInput ? parseInt(idInput) : Date.now(),
                title, content, estStart, estEnd, actStart, actEnd, remarks
            };

            let newJobs = [...jobs];
            if (idInput) {
                const index = newJobs.findIndex(j => j.id == idInput);
                if (index !== -1) newJobs[index] = jobData;
            } else {
                newJobs.push(jobData);
            }

            saveDataToCloud(newJobs);
            resetForm();
        }

        // --- ç·¨è¼¯ ---
        function loadJobToEdit(id) {
            const job = jobs.find(j => j.id === id);
            if (!job) return;

            document.getElementById('editJobId').value = job.id;
            document.getElementById('jobTitle').value = job.title;
            document.getElementById('jobContent').value = job.content;
            
            // ä½¿ç”¨ Flatpickr è¨­å®šæ™‚é–“
            fpEstStart.setDate(job.estStart);
            fpEstEnd.setDate(job.estEnd);
            fpActStart.setDate(job.actStart || '');
            fpActEnd.setDate(job.actEnd || '');

            document.getElementById('remarks').value = job.remarks;

            document.getElementById('formTitle').innerText = "âœï¸ ä¿®æ”¹å·¥ä½œé …ç›®";
            const btn = document.getElementById('submitBtn');
            btn.innerText = "ç¢ºèªä¿®æ”¹";
            btn.classList.replace('bg-blue-600', 'bg-amber-500');
            btn.classList.replace('hover:bg-blue-700', 'hover:bg-amber-600');
            
            document.getElementById('cancelEditBtn').classList.remove('hidden');
            document.getElementById('editStatus').classList.remove('hidden');
            document.getElementById('inputFormCard').classList.add('editing-mode');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // --- é‡ç½® ---
        function resetForm() {
            document.getElementById('editJobId').value = '';
            document.getElementById('jobTitle').value = '';
            document.getElementById('jobContent').value = '';
            document.getElementById('remarks').value = '';
            setDefaultTimes();

            document.getElementById('formTitle').innerText = "æ–°å¢å·¥ä½œé …ç›®";
            const btn = document.getElementById('submitBtn');
            btn.innerText = "æ–°å¢å·¥ä½œ";
            btn.classList.replace('bg-amber-500', 'bg-blue-600');
            btn.classList.replace('hover:bg-amber-600', 'hover:bg-blue-700');

            document.getElementById('cancelEditBtn').classList.add('hidden');
            document.getElementById('editStatus').classList.add('hidden');
            document.getElementById('inputFormCard').classList.remove('editing-mode');
        }

        function deleteJob(id) {
            if(!db) return;
            if(confirm('ç¢ºå®šè¦åˆªé™¤é€™é …å·¥ä½œå—ï¼Ÿ')) {
                const newJobs = jobs.filter(j => j.id !== id);
                saveDataToCloud(newJobs);
                if(document.getElementById('editJobId').value == id) resetForm();
            }
        }

        function clearAllData() {
            if(!db) return;
            if(confirm('è­¦å‘Šï¼šé€™å°‡æœƒæ¸…é™¤ã€Œé›²ç«¯ã€æ‰€æœ‰è³‡æ–™ä¸”ç„¡æ³•å¾©åŸã€‚ç¢ºå®šå—ï¼Ÿ')) {
                db.ref('workJobs').set([]);
                resetForm();
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            return moment(dateString).format("MM/DD HH:mm");
        }
        
        function setDefaultTimes() {
            const today = moment().format('YYYY-MM-DD');
            fpEstStart.setDate(`${today} 08:00`);
            fpEstEnd.setDate(`${today} 17:00`);
            fpActStart.clear();
            fpActEnd.clear();
        }

        // ==========================================
        //  3. ç¨‹å¼é€²å…¥é»
        // ==========================================
        document.addEventListener('DOMContentLoaded', function() {
            moment.locale('zh-tw');
            
            // 1. åˆå§‹åŒ–ä»‹é¢
            initTimeline();
            initPickers(); // å•Ÿç”¨ 24H é¸æ“‡å™¨
            setDefaultTimes();
            
            // 2. è¨­å®šè¶…æ™‚ä¿è­·
            loadingTimeout = setTimeout(() => {
                const overlay = document.getElementById('loadingOverlay');
                if(overlay && overlay.style.display !== 'none') {
                    showError("é€£ç·šæ™‚é–“éé•·ï¼Œè«‹æª¢æŸ¥ç¶²è·¯ã€‚");
                }
            }, 10000);

            // 3. é€£æ¥ Firebase
            try {
                firebase.initializeApp(firebaseConfig);
                db = firebase.database();
                
                document.getElementById('connectionStatus').innerText = "ğŸŸ¢ å·²é€£ç·šè‡³é›²ç«¯";
                document.getElementById('connectionStatus').classList.replace('text-gray-400', 'text-green-600');

                // 4. ç›£è½è³‡æ–™
                const jobsRef = db.ref('workJobs');
                jobsRef.on('value', (snapshot) => {
                    clearTimeout(loadingTimeout);
                    
                    const data = snapshot.val();
                    if (data) {
                        jobs = Array.isArray(data) ? data : Object.values(data);
                        jobs = jobs.filter(j => j != null);
                    } else {
                        jobs = [];
                    }
                    
                    refreshTimelineData(); // é€™è£¡å·²ç¶“æ˜¯å®šç¾©éçš„äº†ï¼Œä¸æœƒå†å ±éŒ¯
                    renderTable();
                    
                    document.getElementById('loadingOverlay').style.display = 'none';

                }, (error) => {
                    clearTimeout(loadingTimeout);
                    console.error("Firebase Error:", error);
                    let msg = "é€£ç·šå¤±æ•—: " + error.message;
                    if (error.code === 'PERMISSION_DENIED') {
                        msg = "æ¬Šé™ä¸è¶³ã€‚è«‹ç¢ºèª Firebase å¾Œå°è¦å‰‡è¨­å®šç‚º trueã€‚";
                    }
                    showError(msg);
                });

            } catch (e) {
                clearTimeout(loadingTimeout);
                console.error(e);
                showError("åˆå§‹åŒ–å¤±æ•—ï¼š" + e.message);
            }
        });
    </script>
</body>
</html>
