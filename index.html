<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å·¥ä½œæ™‚é–“è¦åŠƒèˆ‡è¿½è¹¤ç³»çµ± v3.2 (é™¤éŒ¯å¢å¼·ç‰ˆ)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/locale/zh-tw.min.js"></script>
    <script type="text/javascript" src="https://unpkg.com/vis-timeline/standalone/umd/vis-timeline-graph2d.min.js"></script>
    <link href="https://unpkg.com/vis-timeline/styles/vis-timeline-graph2d.min.css" rel="stylesheet" type="text/css" />
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body { font-family: 'Microsoft JhengHei', sans-serif; background-color: #f3f4f6; }
        #visualization { margin-top: 20px; border: 1px solid #e5e7eb; background: white; border-radius: 8px; }
        .vis-item.expected { background-color: #e0f2fe; border-color: #38bdf8; color: #0c4a6e; } 
        .vis-item.actual { background-color: #dcfce7; border-color: #4ade80; color: #14532d; }
        .vis-item { border-radius: 4px; font-size: 14px; }
        .editing-mode { border: 2px solid #f59e0b; background-color: #fffbeb; }
        
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column;
            color: #555;
        }
    </style>
</head>
<body class="p-6">

    <div id="loadingOverlay">
        <div class="text-2xl font-bold mb-4">â˜ï¸ é›²ç«¯è³‡æ–™é€£ç·šä¸­...</div>
        <div id="loadingMsg" class="text-sm text-gray-500">æ­£åœ¨å˜—è©¦é€£æ¥è³‡æ–™åº«ï¼Œè«‹ç¨å€™...</div>
        <div id="errorActions" class="mt-6 hidden">
            <p class="text-red-500 font-bold mb-2">é€£ç·šä¼¼ä¹æœ‰å•é¡Œï¼Ÿ</p>
            <ul class="text-left text-sm text-gray-700 list-disc pl-5 mb-4 space-y-1">
                <li>è«‹æª¢æŸ¥æ˜¯å¦é–‹å•Ÿäº† <b>AdBlock</b> æˆ–æ“‹å»£å‘Šè»Ÿé«” (è«‹å…ˆé—œé–‰)</li>
                <li>è«‹ç¢ºèªç¶²è·¯æ˜¯å¦æ­£å¸¸</li>
                <li>è«‹ç¢ºèª Firebase å¾Œå°è¦å‰‡æ˜¯å¦å·²æ”¹ç‚º <b>true</b></li>
            </ul>
            <button onclick="location.reload()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 shadow">é‡æ–°æ•´ç†é é¢</button>
        </div>
    </div>

    <div class="max-w-7xl mx-auto">
        <header class="mb-6 flex justify-between items-end">
            <div>
                <h1 class="text-3xl font-bold text-gray-800">â˜ï¸ é›²ç«¯å·¥ä½œè¿½è¹¤ç³»çµ±</h1>
                <p class="text-gray-600">é™¤éŒ¯å¢å¼·ç‰ˆï¼šå¦‚æœé€£ç·šå¤±æ•—æœƒé¡¯ç¤ºå…·é«”åŸå› </p>
            </div>
            <div id="connectionStatus" class="text-sm font-bold text-gray-400">åˆå§‹åŒ–ä¸­...</div>
        </header>

        <div id="inputFormCard" class="bg-white p-6 rounded-lg shadow mb-6 transition-colors duration-300">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 id="formTitle" class="text-xl font-semibold">æ–°å¢å·¥ä½œé …ç›®</h2>
                <span id="editStatus" class="hidden text-sm font-bold text-amber-600 bg-amber-100 px-2 py-1 rounded">âœï¸ æ­£åœ¨ç·¨è¼¯æ¨¡å¼</span>
            </div>
            
            <input type="hidden" id="editJobId">

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">å·¥ä½œä¸»æ—¨ <span class="text-red-500">*</span></label>
                        <input type="text" id="jobTitle" class="mt-1 block w-full rounded-md border border-gray-300 p-2 shadow-sm focus:border-blue-500 focus:ring-1 focus:ring-blue-500" placeholder="ä¾‹å¦‚ï¼šç¶²ç«™å‰ç«¯é–‹ç™¼">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">å·¥ä½œå…§å®¹</label>
                        <textarea id="jobContent" class="mt-1 block w-full rounded-md border border-gray-300 p-2 shadow-sm" rows="3" placeholder="è©³ç´°å…§å®¹æè¿°..."></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">å‚™è¨»</label>
                        <input type="text" id="remarks" class="mt-1 block w-full rounded-md border border-gray-300 p-2 shadow-sm" placeholder="ä¾‹å¦‚ï¼šéœ€ç­‰å¾…è¨­è¨ˆåœ–ç¢ºèª">
                    </div>
                </div>

                <div class="space-y-3 bg-gray-50 p-4 rounded border border-gray-200">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-bold text-blue-700">ğŸ”µ é è¨ˆé–‹å§‹ <span class="text-red-500">*</span></label>
                            <input type="datetime-local" id="estStart" class="mt-1 block w-full rounded border-gray-300 p-1">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-blue-700">é è¨ˆçµæŸ <span class="text-red-500">*</span></label>
                            <input type="datetime-local" id="estEnd" class="mt-1 block w-full rounded border-gray-300 p-1">
                        </div>
                    </div>
                    <hr class="border-gray-300">
                    <div class="grid grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-bold text-green-700">ğŸŸ¢ å¯¦éš›é–‹å§‹ (é¸å¡«)</label>
                            <input type="datetime-local" id="actStart" class="mt-1 block w-full rounded border-gray-300 p-1">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-green-700">å¯¦éš›çµæŸ (é¸å¡«)</label>
                            <input type="datetime-local" id="actEnd" class="mt-1 block w-full rounded border-gray-300 p-1">
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-6 flex justify-end gap-3">
                <button id="cancelEditBtn" onclick="resetForm()" class="hidden px-4 py-2 border border-gray-300 text-gray-700 rounded hover:bg-gray-50">å–æ¶ˆç·¨è¼¯</button>
                <button onclick="clearAllData()" class="text-sm text-red-400 hover:text-red-600 underline mr-auto">æ¸…é™¤æ‰€æœ‰è³‡æ–™</button>
                <button id="submitBtn" onclick="handleFormSubmit()" class="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 shadow font-bold transition-colors">æ–°å¢å·¥ä½œ</button>
            </div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow mb-6">
            <h2 class="text-xl font-semibold mb-2">ğŸ“Š æ™‚é–“è»¸è¦–åœ–</h2>
            <div id="visualization"></div>
        </div>

        <div class="bg-white p-6 rounded-lg shadow overflow-x-auto">
            <h2 class="text-xl font-semibold mb-4">ğŸ“‹ è©³ç´°æ¸…å–®</h2>
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">æ“ä½œ</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">ä¸»æ—¨</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">å…§å®¹</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-blue-600 uppercase">é è¨ˆæ™‚é–“</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-green-600 uppercase">å¯¦éš›æ™‚é–“</th>
                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase">å‚™è¨»</th>
                    </tr>
                </thead>
                <tbody id="jobTableBody" class="bg-white divide-y divide-gray-200 text-sm"></tbody>
            </table>
        </div>
    </div>

    <script>
        // --- æ‚¨çš„ Firebase è¨­å®š ---
        const firebaseConfig = {
            apiKey: "AIzaSyB7coN0YZ5XFvSG4vrD4rvLRGSVH_kmCxY",
            authDomain: "worktracker-41d89.firebaseapp.com",
            databaseURL: "https://worktracker-41d89-default-rtdb.firebaseio.com",
            projectId: "worktracker-41d89",
            storageBucket: "worktracker-41d89.firebasestorage.app",
            messagingSenderId: "182899210000",
            appId: "1:182899210000:web:d86f11e118e6fb68e75795"
        };

        // --- åˆå§‹åŒ– Firebase ---
        let db;
        
        // è¨­å®šä¸€å€‹ 8 ç§’çš„è¨ˆæ™‚å™¨ï¼Œå¦‚æœå¤ªä¹…æ²’åæ‡‰å°±é¡¯ç¤ºã€Œé‡è©¦æŒ‰éˆ•ã€
        const loadingTimeout = setTimeout(() => {
            const overlay = document.getElementById('loadingOverlay');
            if(overlay && overlay.style.display !== 'none') {
                document.getElementById('loadingMsg').innerText = "âš ï¸ é€£ç·šå›æ‡‰æ™‚é–“éé•·...";
                document.getElementById('errorActions').classList.remove('hidden');
            }
        }, 8000);

        try {
            firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            
            document.getElementById('connectionStatus').innerText = "ğŸŸ¢ å·²é€£ç·šè‡³é›²ç«¯";
            document.getElementById('connectionStatus').classList.replace('text-gray-400', 'text-green-600');
        } catch (e) {
            console.error(e);
            showError("Firebase åˆå§‹åŒ–å¤±æ•—ï¼š" + e.message);
        }

        // --- å…¨åŸŸè®Šæ•¸ ---
        let jobs = [];
        let timeline;
        let items;
        let groups;

        // --- ç¨‹å¼é€²å…¥é» ---
        document.addEventListener('DOMContentLoaded', function() {
            moment.locale('zh-tw');
            initTimeline();
            setDefaultTimes();

            // ç›£è½é›²ç«¯è³‡æ–™åº«è®ŠåŒ– (åŒ…å«éŒ¯èª¤è™•ç†)
            if(db) {
                const jobsRef = db.ref('workJobs');
                
                // ä½¿ç”¨ on çš„ç¬¬äºŒå€‹åƒæ•¸ä¾†æ•æ‰éŒ¯èª¤
                jobsRef.on('value', (snapshot) => {
                    // --- æˆåŠŸå–å¾—è³‡æ–™ ---
                    clearTimeout(loadingTimeout); // æ¸…é™¤è¶…æ™‚è­¦å‘Š
                    
                    const data = snapshot.val();
                    if (data) {
                        jobs = Array.isArray(data) ? data : Object.values(data);
                        jobs = jobs.filter(j => j != null);
                    } else {
                        jobs = [];
                    }
                    refreshTimelineData();
                    renderTable();
                    
                    // é—œé–‰é®ç½©
                    document.getElementById('loadingOverlay').style.display = 'none';

                }, (error) => {
                    // --- ç™¼ç”ŸéŒ¯èª¤ (æ¬Šé™ä¸è¶³æˆ–è¢«æ“‹) ---
                    clearTimeout(loadingTimeout);
                    console.error("Firebase è®€å–éŒ¯èª¤:", error);
                    
                    let errorMsg = "è®€å–è³‡æ–™åº«å¤±æ•—ï¼";
                    if (error.code === 'PERMISSION_DENIED') {
                        errorMsg = "âŒ æ¬Šé™è¢«æ‹’çµ• (PERMISSION_DENIED)ã€‚\nè«‹è‡³ Firebase Console > Realtime Database > è¦å‰‡ (Rules)ï¼Œå°‡ read å’Œ write éƒ½è¨­ç‚º trueã€‚";
                    } else {
                        errorMsg = "âŒ é€£ç·šéŒ¯èª¤: " + error.message;
                    }
                    showError(errorMsg);
                });
            }
        });

        // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯åœ¨ç•«é¢ä¸Š
        function showError(msg) {
            document.getElementById('loadingMsg').innerText = msg;
            document.getElementById('loadingMsg').classList.add('text-red-600', 'font-bold');
            document.getElementById('errorActions').classList.remove('hidden');
            alert(msg); // åŒæ™‚å½ˆå‡ºè¦–çª—æé†’
        }

        // --- è¨­å®šé è¨­æ™‚é–“ ---
        function setDefaultTimes() {
            const now = new Date();
            const todayDate = moment(now).format('YYYY-MM-DD');
            document.getElementById('estStart').value = `${todayDate}T08:00`;
            document.getElementById('estEnd').value = `${todayDate}T17:00`;
            document.getElementById('actStart').value = '';
            document.getElementById('actEnd').value = '';
        }

        // --- æ™‚é–“è»¸åˆå§‹åŒ– ---
        function initTimeline() {
            const container = document.getElementById('visualization');
            groups = new vis.DataSet();
            items = new vis.DataSet();

            const options = {
                groupOrder: 'content',
                editable: { add: false, updateTime: true, updateGroup: false, remove: true },
                margin: { item: 10 },
                orientation: 'top',
                stack: false,
                zoomKey: 'ctrlKey',
                maxHeight: '500px',
                verticalScroll: true,
                locale: 'zh-tw',
                format: {
                    minorLabels: { minute: 'HH:mm', hour: 'HH:mm', weekday: 'M/D (ddd)', day: 'M/D (ddd)', month: 'YYYYå¹´ Mæœˆ' },
                    majorLabels: { minute: 'ddd D HH:mm', hour: 'ddd D HH:mm', weekday: 'YYYYå¹´ Mæœˆ', day: 'YYYYå¹´ Mæœˆ', month: 'YYYYå¹´' }
                },
                zoomMin: 1000 * 60 * 60, 
            };

            timeline = new vis.Timeline(container, items, groups, options);
            
            items.on('update', function (event, properties) {
                if (properties.data && properties.data.length > 0) {
                    updateJobFromTimeline(properties.data[0]);
                }
            });
        }

        // --- è¡¨å–®æäº¤ ---
        function handleFormSubmit() {
            if(!db) { alert("å°šæœªé€£ç·šåˆ°è³‡æ–™åº«ï¼Œç„¡æ³•å„²å­˜"); return; }
            
            const idInput = document.getElementById('editJobId').value;
            const title = document.getElementById('jobTitle').value;
            const content = document.getElementById('jobContent').value;
            const estStart = document.getElementById('estStart').value;
            const estEnd = document.getElementById('estEnd').value;
            const actStart = document.getElementById('actStart').value;
            const actEnd = document.getElementById('actEnd').value;
            const remarks = document.getElementById('remarks').value;

            if (!title || !estStart || !estEnd) {
                alert("è«‹å‹™å¿…å¡«å¯«ï¼šå·¥ä½œä¸»æ—¨ã€é è¨ˆé–‹å§‹æ™‚é–“ã€é è¨ˆçµæŸæ™‚é–“");
                return;
            }
            if (new Date(estStart) > new Date(estEnd)) {
                alert("é è¨ˆé–‹å§‹æ™‚é–“ä¸èƒ½æ™šæ–¼çµæŸæ™‚é–“");
                return;
            }

            const jobData = {
                id: idInput ? parseInt(idInput) : Date.now(),
                title, content, estStart, estEnd, actStart, actEnd, remarks
            };

            let newJobs = [...jobs];
            if (idInput) {
                const index = newJobs.findIndex(j => j.id == idInput);
                if (index !== -1) newJobs[index] = jobData;
            } else {
                newJobs.push(jobData);
            }

            saveDataToCloud(newJobs);
            resetForm();
        }

        function saveDataToCloud(newJobsData) {
            db.ref('workJobs').set(newJobsData)
                .then(() => console.log("åŒæ­¥æˆåŠŸ"))
                .catch((err) => {
                    console.error(err);
                    alert("å„²å­˜å¤±æ•—ï¼\néŒ¯èª¤: " + err.message + "\n(è«‹æª¢æŸ¥æ˜¯å¦æœ‰æ¬Šé™å¯«å…¥)");
                });
        }

        // --- ç·¨è¼¯ ---
        function loadJobToEdit(id) {
            const job = jobs.find(j => j.id === id);
            if (!job) return;

            document.getElementById('editJobId').value = job.id;
            document.getElementById('jobTitle').value = job.title;
            document.getElementById('jobContent').value = job.content;
            document.getElementById('estStart').value = job.estStart;
            document.getElementById('estEnd').value = job.estEnd;
            document.getElementById('actStart').value = job.actStart;
            document.getElementById('actEnd').value = job.actEnd;
            document.getElementById('remarks').value = job.remarks;

            document.getElementById('formTitle').innerText = "âœï¸ ä¿®æ”¹å·¥ä½œé …ç›®";
            const btn = document.getElementById('submitBtn');
            btn.innerText = "ç¢ºèªä¿®æ”¹";
            btn.classList.replace('bg-blue-600', 'bg-amber-500');
            btn.classList.replace('hover:bg-blue-700', 'hover:bg-amber-600');
            
            document.getElementById('cancelEditBtn').classList.remove('hidden');
            document.getElementById('editStatus').classList.remove('hidden');
            document.getElementById('inputFormCard').classList.add('editing-mode');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetForm() {
            document.getElementById('editJobId').value = '';
            document.getElementById('jobTitle').value = '';
            document.getElementById('jobContent').value = '';
            document.getElementById('remarks').value = '';
            setDefaultTimes();

            document.getElementById('formTitle').innerText = "æ–°å¢å·¥ä½œé …ç›®";
            const btn = document.getElementById('submitBtn');
            btn.innerText = "æ–°å¢å·¥ä½œ";
            btn.classList.replace('bg-amber-500', 'bg-blue-600');
            btn.classList.replace('hover:bg-amber-600', 'hover:bg-blue-700');

            document.getElementById('cancelEditBtn').classList.add('hidden');
            document.getElementById('editStatus').classList.add('hidden');
            document.getElementById('inputFormCard').classList.remove('editing-mode');
        }

        function deleteJob(id) {
            if(!db) return;
            if(confirm('ç¢ºå®šè¦åˆªé™¤é€™é …å·¥ä½œå—ï¼Ÿ')) {
                const newJobs = jobs.filter(j => j.id !== id);
                saveDataToCloud(newJobs);
                if(document.getElementById('editJobId').value == id) resetForm();
            }
        }

        function clearAllData() {
            if(!db) return;
            if(confirm('è­¦å‘Šï¼šé€™å°‡æœƒæ¸…é™¤ã€Œé›²ç«¯ã€æ‰€æœ‰è³‡æ–™ä¸”ç„¡æ³•å¾©åŸã€‚ç¢ºå®šå—ï¼Ÿ')) {
                db.ref('workJobs').set([]);
                resetForm();
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '';
            const d = new Date(dateString);
            return `${d.getMonth()+1}/${d.getDate()} ${d.getHours().toString().padStart(2, '0')}:${d.getMinutes().toString().padStart(2, '0')}`;
        }
    </script>
</body>
</html>
